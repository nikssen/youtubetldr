name: Build YouTubeTLDR (release-only)

on:
  schedule:
    - cron: "17 3 * * *" # daily check; will only build when a new upstream release appears
  workflow_dispatch:
    inputs:
      force:
        description: "Force rebuild even if the version tag already exists in GHCR"
        required: false
        default: "false"

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/youtubetldr
  UPSTREAM_REPO: Milkshiift/YouTubeTLDR

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine latest upstream release tag
        id: upstream
        run: |
          set -euo pipefail

          RELEASE_JSON="$(curl -fsSL "https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest")"
          UPSTREAM_TAG="$(echo "$RELEASE_JSON" | jq -r .tag_name)"     # e.g. v1.6.0
          VERSION="${UPSTREAM_TAG#v}"                                  # e.g. 1.6.0

          echo "upstream_tag=$UPSTREAM_TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION
